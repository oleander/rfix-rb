#!/usr/bin/env -S ruby -W0 --disable-all
# frozen_string_literal: true

require "rubygems"
require "bootsnap"
require "bundler"
require "xdg"

Bootsnap.setup(
  cache_dir: XDG::Cache.new.home.join("rfix").to_s,
  development_mode: "development",
  load_path_cache: true,
  compile_cache_iseq: true,
  compile_cache_yaml: true
)

unless defined?(Rfix)
  if $PROGRAM_NAME.end_with?("exe/rfix")
    require "bundler/setup"
    Bundler.require(:test, :default)
  else
    lockfile = Bundler::LockfileParser.new(Bundler.default_lockfile.read)
    if (rfix = lockfile.specs.detect { |spec| spec.name == "rfix" })
      Gem.use_paths Gem.dir, Bundler.bundle_path.to_s, *Gem.path
      gem "rfix", rfix.version
    end
  end

  require "rfix"
end

Rfix::CLI::Command.setup
